# `/api/properties` API Documentation

## Overview

This API endpoint allows **reading, creating, updating, and deleting properties** in the system.
Authentication for admin-only actions (POST, PUT, DELETE) is handled via a **Bearer token** automatically provided by your `axios-instance`.

* Public read (GET) does **not require authentication**.
* Admin actions (POST, PUT, DELETE) require the user to have `role = 'admin'` in the `user_profiles` table.

---

## HTTP Methods

### GET `/api/properties`

**Description:** Fetch properties.

**Query Parameters:**

| Parameter | Type          | Description                                                 |
|-----------|---------------|-------------------------------------------------------------|
| `id`      | string (UUID) | Fetch property by its unique ID. Optional.                  |
| `num`     | string        | Fetch property by `property_number`. Optional.              |
| `seq`     | integer       | Fetch property by `property_seq`. Optional.                 |
| `page`    | integer       | Pagination: page number (default: 1). Optional.             |
| `per`     | integer       | Pagination: items per page (max 100, default 20). Optional. |

**Response:**

```json
{
  "ok": true,
  "data": [
    {
      "id": "uuid",
      "title": "Apartment 2 Bedrooms in Tehran",
      "category": "rent",
      "price": 1200,
      "price_with_discount": 1000,
      "main_image": "https://example.com/main.jpg",
      "images": [
        "https://example.com/1.jpg",
        "https://example.com/2.jpg"
      ],
      "description": "Full description of the property...",
      "tags": [
        "new",
        "central"
      ],
      "province_and_city": "Tehran, Tehran",
      "address": "123 Main St",
      "metadata": {
        "rooms": 2,
        "area_m2": 85,
        "floor": 3,
        "heating": "central",
        "year_built": 1398
      },
      "features": [
        "elevator",
        "parking"
      ],
      "discount_until": "2025-12-31T23:59:59Z",
      "property_number": "APT-001",
      "property_seq": 1,
      "stock": 1,
      "created_at": "2025-11-09T12:00:00Z",
      "updated_at": "2025-11-09T12:00:00Z"
    }
  ]
}
```

---

### POST `/api/properties`

**Description:** Create a new property (admin only).
**Authentication:** Bearer token (from `axios-instance`).

**Request Body JSON Schema:**

```json
{
  "description": "Payload for creating a property",
  "type": "object",
  "properties": {
    "id": {
      "type": "string",
      "format": "uuid",
      "description": "Optional unique ID; generated by server if not provided."
    },
    "title": {
      "type": "string",
      "description": "Property title",
      "example": "2 Bedroom Apartment in Tehran"
    },
    "category": {
      "type": "string",
      "enum": [
        "rent",
        "sale"
      ],
      "description": "Property category ('rent' or 'sale')"
    },
    "price": {
      "type": "number",
      "description": "Property price (monthly for rent)"
    },
    "price_with_discount": {
      "type": "number",
      "description": "Price after discount"
    },
    "description": {
      "type": "string",
      "description": "Full property description"
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Tags, default empty array"
    },
    "province_and_city": {
      "type": "string",
      "description": "Province and city, e.g. 'Tehran, Tehran'"
    },
    "address": {
      "type": "string",
      "description": "Exact address or description"
    },
    "metadata": {
      "type": "object",
      "description": "Structured data like rooms, area, floor, heating, year built"
    },
    "features": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "At least one feature required"
    },
    "discount_until": {
      "type": "string",
      "format": "date-time",
      "description": "Discount expiry date"
    },
    "property_number": {
      "type": "string",
      "description": "Optional property number"
    },
    "stock": {
      "type": "integer",
      "description": "Stock quantity, default 1, allowed values: 0 or 1"
    }
  },
  "required": [
    "title",
    "category",
    "description",
    "province_and_city",
    "address",
    "features"
  ]
}
```
**DATA Json Example**

```json
{
  "title": "2 Bedroom Apartment in Tehran",
  "category": "sale",
  "price": 1200,
  "price_with_discount": 1000,
  "description": "A spacious 2-bedroom apartment in the heart of Tehran, with modern amenities, elevator, and parking space.",
  "tags": [
    "apartment",
    "central",
    "parking"
  ],
  "province_and_city": "Tehran, Tehran",
  "address": "No. 12, Valiasr St, Tehran",
  "metadata": {
    "rooms": 2,
    "area_m2": 85,
    "floor": 3,
    "heating": "central",
    "year_built": 1398
  },
  "features": [
    "elevator",
    "parking"
  ],
  "discount_until": "2025-12-31T23:59:59Z",
  "property_number": "APT-2025-001",
  "stock": 1
}
```


**Response Example:**

```json
{
  "ok": true,
  "property": {
    "id": "uuid",
    "title": "2 Bedroom Apartment in Tehran",
    "category": "rent",
    "price": 1200,
    "description": "Full description...",
    "province_and_city": "Tehran, Tehran",
    "address": "123 Main St",
    "features": [
      "elevator",
      "parking"
    ],
    "images": [],
    "tags": [],
    "metadata": {
      "rooms": 2,
      "area_m2": 85,
      "floor": 3,
      "heating": "central",
      "year_built": 1398
    },
    "created_at": "2025-11-09T12:00:00Z",
    "updated_at": "2025-11-09T12:00:00Z"
  }
}
```

**Validation Notes:**

* `category`: must be `'rent'` or `'sale'`.
* `features`: must have at least one item.
* `property_seq`: generated by DB automatically, do not send manually.
* `id`: optional, generated if missing; must be a valid UUID if provided.
* `images` and `tags`: arrays, default empty.
* `metadata`: JSONB for structured fields (rooms, area, floor, heating, etc.).
* `stock`: only `0` or `1`, default `1`.

---

### PUT `/api/properties`

**Description:** Update property by `id` or `property_number` (admin only).
**Authentication:** Bearer token.

* Payload must include either `id` or `property_number`.
* `property_seq` cannot be updated manually.

---

### DELETE `/api/properties`

**Description:** Delete property by `id` or `property_number` (admin only).
**Authentication:** Bearer token.

* Payload or query parameter must include either `id` or `property_number`.

---

### Error Responses

| Status | Error Code         | Description                           |
|--------|--------------------|---------------------------------------|
| 400    | MISSING_FIELD      | Required field is missing             |
| 400    | INVALID_PRICE      | Price is invalid                      |
| 400    | INVALID_CATEGORY   | Category not 'rent' or 'sale'         |
| 400    | INVALID_FEATURES   | Features array invalid                |
| 403    | FORBIDDEN          | Admin-only action without valid token |
| 404    | NOT_FOUND          | Property not found                    |
| 404    | DELETE_FAILED      | Failed to delete property             |
| 500    | INTERNAL_ERROR     | Unexpected server error               |
| 405    | METHOD_NOT_ALLOWED | Unsupported HTTP method               |

---

ðŸ’¡ **Note:** All admin actions rely on the Bearer token automatically included in requests from your `axios-instance`.